FROM registry.access.redhat.com/ubi10/nodejs-22:10.1-1771303085 AS builder
USER root

RUN mkdir -p SGXDataCenterAttestationPrimitives/QuoteVerification/QVL
WORKDIR SGXDataCenterAttestationPrimitives
COPY DCAP/ ./

RUN dnf install -y nodejs-devel sgx-libs && ln -s /usr/include/node/config-x86_64.gypi /usr/include/node/config.gypi

RUN mkdir -p prebuilt/openssl/inc \
    && mkdir -p QuoteGeneration/pccs/lib \
    && cp /usr/lib64/libPCKCertSelection.so.1 QuoteGeneration/pccs/lib/libPCKCertSelection.so

WORKDIR QuoteGeneration/pccs
COPY package-lock.json .
COPY package.json .
RUN npm config set engine-strict true \
    && npm_config_nodedir=/usr npm install --build-from-source --loglevel=silly

FROM registry.access.redhat.com/ubi10/nodejs-22-minimal:10.1-1767601359

WORKDIR /opt/intel/pccs

COPY --from=builder --chown=1001:users /opt/app-root/src/SGXDataCenterAttestationPrimitives/QuoteGeneration/pccs .
COPY --chown=1001:users default.json config/
COPY --chown=1001:users custom-environment-variables.json config/

# Red Hat labels
LABEL name="openshift-sandboxed-containers/osc-pccs" \
cpe="cpe:/a:redhat:confidential_compute_attestation:1.11::el9" \
version="1.11" \
com.redhat.component="osc-pccs" \
summary="Intel SGX Provisioning Certificate Caching Service (PCCS)" \
maintainer="redhat@redhat.com" \
description="Intel SGX Provisioning Certificate Caching Service (PCCS) for Openshift Sandboxed Containers" \
io.k8s.display-name="openshift-sandboxed-containers-pccs" \
io.k8s.description="Intel SGX Provisioning Certificate Caching Service (PCCS) for Openshift Sandboxed Containers" \
io.openshift.tags=""

ENTRYPOINT ["/usr/bin/node", "pccs_server.js"]
