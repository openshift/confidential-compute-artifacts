FROM registry.access.redhat.com/ubi9/nodejs-22:9.6-1762763285 AS builder

USER root

RUN mkdir -p SGXDataCenterAttestationPrimitives/QuoteVerification/QVL
WORKDIR SGXDataCenterAttestationPrimitives
RUN tar xf /cachi2/output/deps/generic/dcap-source.tar.gz --strip-components=1

WORKDIR QuoteVerification/QVL
RUN tar xf /cachi2/output/deps/generic/qvl-source.tar.gz --strip-components=1

WORKDIR ../../tools/PCKCertSelection/
RUN mkdir -p ../../prebuilt/openssl/inc \
    && mkdir -p ../../QuoteGeneration/pccs/lib \
    && make -C PCKCertSelectionLib \
    && cp ./out/libPCKCertSelection.so ../../QuoteGeneration/pccs/lib

WORKDIR ../../QuoteGeneration/pccs
COPY package-lock.json .
COPY package.json .
RUN dnf module install -y nodejs:22/development && ln -s /usr/include/node/config-x86_64.gypi /usr/include/node/config.gypi
RUN npm config set engine-strict true \
    && npm_config_nodedir=/usr npm install --build-from-source

FROM registry.access.redhat.com/ubi9/nodejs-22-minimal:9.6-1760544659

WORKDIR /opt/intel/pccs

COPY --from=builder --chown=1001:users /opt/app-root/src/SGXDataCenterAttestationPrimitives/QuoteGeneration/pccs .
COPY --chown=1001:users default.json config/
COPY --chown=1001:users custom-environment-variables.json config/

ENTRYPOINT ["/usr/bin/node", "pccs_server.js"]
